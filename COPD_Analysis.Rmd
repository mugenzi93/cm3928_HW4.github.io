---
title: "Longitudinal Analysis of sLTPs/QES"
author: "Clement Mugenzi"
date: "8/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```



```{r packages}
library(tidyverse)
library(data.table)
library(ggplot2)
library(knitr)
library(dplyr)
library(networkD3)
```



# Introduction

This document explore the longitudinal progression of emphysema subtypes (sLTPs/QES) over time - from either baseline or any other QES form to after 5 or 6 years later and so on. The dataset is comprised of CT scans from COPD patients.

Different patients have different proportions on emphysema, so that is why also different pixels (corresponding to the number of observations) were recorded - What I call multiple measures. In other words, different patients had different number of QES pixels labeled for their lungs.

**Data Description:**

* **IDNO:** Patient ID Number

* **X,Y,Z:** Pixel coordinates

* **sLTP(COPD1);NE = -1:** Baseline Spatially-Informed Lung Texture Patterns, where -1 means 'No Emphysema' and where sLTPs span a 1-10 range.

* **sLTP(COPD2);NE = -1:** Spatially-Informed Lung Texture Patterns at follow up.

* **Key Definitions: NE = No Emphyesema**



```{r}
copd_df = fread("spatial-temporal_mesa_copd.csv", data.table = F) %>%
  janitor::clean_names() %>%
  dplyr::select(-v8,-dice) %>%
  rename(sLTP_baseline = s_ltp_copd1_ne_1,
         sLTP_follow_up = s_ltp_copd2_ne_1) %>%
  mutate(
    sLTP_baseline = factor(sLTP_baseline, levels = c("3","5","9","4",
                                                     "6","7","-1","8","10","1","2")),
    sLTP_follow_up = factor(sLTP_follow_up, levels = c("3","5","9","4",
                                                     "6","7","8","10","1","2")),
    qes_baseline = recode(sLTP_baseline, "1" = "Vanishing", "2" = "Vanishing","-1" = "NE", 
                          "4" = "Diffuse", "6" = "Diffuse", "7" = "Senile",
                          "3" = "Apical", "5" = "Apical", "9" = "Apical",
                          "8" = "oCPFE", "10" = "rCPFE"),
    qes_follow_up = recode(sLTP_follow_up, "1" = "Vanishing", "2" = "Vanishing","-1" = "NE", 
                           "4" = "Diffuse", "6" = "Diffuse", "7" = "Senile",
                          "3" = "Apical", "5" = "Apical", "9" = "Apical",
                          "8" = "oCPFE", "10" = "rCPFE"),
    qes_baseline = factor(qes_baseline, levels = c("Apical","Diffuse","NE","Senile","oCPFE","rCPFE", "Vanishing")),
    qes_follow_up = factor(qes_follow_up, levels = c("Apical","Diffuse","Senile","oCPFE","rCPFE","Vanishing"))
  )
```




```{r}
# the dataset we want
copd_wewant = copd_df %>%
  filter(!(qes_baseline != "NE" & qes_follow_up == "NE"))
```


## Sankey Diagram - sLTP Transitions

```{r sltp_transitions}
# transforming the dataset
data_sankey_sltp = copd_wewant %>%
  filter(sLTP_follow_up != "-1") %>%
  dplyr::select(idno,sLTP_baseline,sLTP_follow_up) %>%
  group_by(sLTP_baseline,sLTP_follow_up) %>%
  summarize(Freq = n(),.groups = "drop") %>%
  dplyr::select(sLTP_baseline,sLTP_follow_up, Freq) %>%
  rename(source = sLTP_baseline, target = sLTP_follow_up, value = Freq)

data_sankey_sltp$target <- paste(data_sankey_sltp$target, " ", sep = "")

# defining the nodes
nodes_sltp = data.frame(name = c(as.character(data_sankey_sltp$source), as.character(data_sankey_sltp$target)) %>% unique())

# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_sankey_sltp$IDsource = match(data_sankey_sltp$source, nodes_sltp$name) - 1
data_sankey_sltp$IDtarget = match(data_sankey_sltp$target, nodes_sltp$name) - 1

# prepare colour scale
ColourScal1 = 'd3.scaleOrdinal() .range(["#FFFF00","#006400","#FF00FF","#7FFF00",
"#00FFFF","#0000FF","#FFE4E1","#800080","#DC143C","#FF0000","#808080"])'

# Make the Network
sankeyNetwork(Links = data_sankey_sltp, Nodes = nodes_sltp,
                     Source = "IDsource", Target = "IDtarget", colourScale = ColourScal1,
                     Value = "value", NodeID = "name", iterations = 0,
                     sinksRight = F, nodeWidth = 40, fontSize = 13, nodePadding = 20)
```

The **Sankey Diagram** above showcases how sLTP at baseline transitioned to follow up. The thicker the line the more frequent transitions appearing in the data. 


```{r, results='asis', echo=FALSE}
cat("\\newpage")
```


## The Sankey Diagram - QES Transitions

In this plot and because of clarity reasons, I ignored the transition from No Emphysema at baseline to No Emohysema at follow up and only included transitions from either NE or any QES (Baseline) to any of the QES at follow up. 

```{r qes_transitions}
# transforming the dataset
data_sankey = copd_wewant %>%
  filter(qes_follow_up != "NE") %>% 
  dplyr::select(idno,qes_baseline,qes_follow_up) %>% 
  group_by(qes_baseline,qes_follow_up) %>%
  summarize(Freq = n(),.groups = "drop") %>%
  dplyr::select(qes_baseline,qes_follow_up, Freq) %>%
  rename(source = qes_baseline, target = qes_follow_up, value = Freq)

data_sankey$target <- paste(data_sankey$target, " ", sep = "")

# defining the nodes
nodes = data.frame(name = c(as.character(data_sankey$source), as.character(data_sankey$target)) %>% unique())

# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_sankey$IDsource = match(data_sankey$source, nodes$name) - 1
data_sankey$IDtarget = match(data_sankey$target, nodes$name) - 1

# prepare colour scale
ColourScal = 'd3.scaleOrdinal() .range(["#FFFF00","#7FFF00","#FFE4E1",
"#0000FF","#800080","#FF69B4","#FF0000"])'


# Make the Network
sankeyNetwork(Links = data_sankey, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget", colourScale = ColourScal,
                     Value = "value", NodeID = "name", iterations = 0,
                     sinksRight = F, nodeWidth = 40, fontSize = 13, nodePadding = 20)
```

The **Sankey Diagram** above showcases how QES at baseline transitioned to follow up. The thicker the line the more frequent transitions appearing in the data.



```{r}
# average number of x,y,z per subject
avg_3d = copd_wewant %>%
  group_by(idno) %>%
  summarise(
    avg_x = round(mean(x)),
    avg_y = round(mean(y)),
    avg_z = round(mean(z))
  )

write.csv(avg_3d, file = "Average3D.csv", row.names = F)
```
















